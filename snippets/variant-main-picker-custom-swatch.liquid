{%- doc -%}
  Renders a variant picker with custom metaobject swatch support.

  For each product option, checks whether any variant has a custom.custom_swatch
  metafield (a reference to a custom_swatch metaobject). When found, that option
  renders as a swatch fieldset using the metaobject's color, name, and description
  fields. Options without the metafield fall back to theme swatches or buttons/dropdowns.

  Metaobject fields expected on custom_swatch:
    color       — color type  → used as the swatch background
    name        — single-line text → used as the accessible label
    description — single-line text → shown as a tooltip (title attribute)

  @param {object} product_resource - The product object.
  @param {object} [block] - The block object (available automatically in block context).
{%- enddoc -%}

{% assign block_settings = block.settings %}

{% unless product_resource.has_only_default_variant %}
  {% liquid
    assign button_background_brightness = section.settings.color_scheme.settings.foreground | color_brightness
    if button_background_brightness < 105
      assign strikethrough_color_mix = '#000'
    else
      assign strikethrough_color_mix = '#fff'
    endif
  %}
  <variant-picker
    class="variant-picker spacing-style variant-picker--{{ block_settings.alignment }}"
    style="--color-strikethrough-mix: {{ strikethrough_color_mix }}; {% render 'spacing-style', settings: block_settings %}{% if block_settings.custom_swatch_active_border_color != blank %} --custom-swatch-active-border-color: {{ block_settings.custom_swatch_active_border_color }};{% endif %}"
    data-section-id="{{ section.id }}"
    data-product-id="{{ product_resource.id }}"
    data-block-id="{{ block.id }}"
    data-product-url="{{ product_resource.url }}"
    ref="mainVariantPicker"
    {% if product.id == product_resource.id %}
      data-template-product-match="true"
    {% endif %}
    {{ block.shopify_attributes }}
    {% if request.visual_preview_mode %}
      data-shopify-visual-preview
    {% endif %}
  >
    <form class="variant-picker__form">
      {%- for product_option in product_resource.options_with_values -%}
        {%- liquid
          # Determine whether this option has custom_swatch metaobject data on any variant.
          assign has_custom_swatch = false
          for product_option_value in product_option.values
            if product_option_value.variant.metafields.custom.custom_swatch.value != blank
              assign has_custom_swatch = true
              break
            endif
          endfor

          assign variant_style = block_settings.variant_style

          if has_custom_swatch and block_settings.show_swatches
            assign variant_style = 'swatch'
          elsif block_settings.show_swatches
            assign swatch_count = product_option.values | map: 'swatch' | compact | size
            if swatch_count > 0
              if block_settings.variant_style == 'dropdown'
                assign variant_style = 'swatch_dropdown'
              else
                assign variant_style = 'swatch'
              endif
            endif
          endif

          if variant_style == 'buttons' and settings.variant_button_width == 'equal-width-buttons'
            assign fieldset_id = section.id | append: '-' | append: product_resource.id | append: '-' | append: product_option.name | handleize
            assign option_id_attribute = 'data-option-id="' | append: fieldset_id | append: '"'
            assign longest_value = 0
          endif
        -%}

        {%- if product_option.values.size == 1 and variant_style != 'swatch' -%}
          <div
            class="variant-option"
            data-testid="variant-option-single"
          >
            {{- product_option.name | escape -}}
            <span
              class="variant-option__swatch-value"
              data-testid="variant-option-single-value"
            >
              {{- product_option.selected_value -}}
            </span>
          </div>
        {%- elsif variant_style == 'swatch' or block_settings.variant_style == 'buttons' -%}
          {%- assign fieldset_index = forloop.index0 -%}
          <fieldset
            class="variant-option variant-option--buttons{% if variant_style == 'swatch' %}{% if has_custom_swatch %} variant-option--custom-swatches{% else %} variant-option--swatches{% endif %}{% else %} variant-option--{{ settings.variant_button_width }}{% endif %}"
            data-fieldset-index="{{ fieldset_index }}"
            ref="fieldsets[]"
            {{ option_id_attribute }}
          >
            <legend>
              {{ product_option.name | escape }}
            </legend>
            {%- for product_option_value in product_option.values -%}
              {%- liquid
                # Resolve the custom_swatch metaobject for this option value's variant.
                assign custom_swatch = nil
                if has_custom_swatch and variant_style == 'swatch'
                  assign custom_swatch = product_option_value.variant.metafields.custom.custom_swatch.value
                endif

                # Use the metaobject name as the accessible label when available.
                assign swatch_aria_label = product_option_value.name
                if custom_swatch != blank and custom_swatch.name.value != blank
                  assign swatch_aria_label = custom_swatch.name.value
                endif

                if product_option_value.size > longest_value and option_id_attribute
                  assign longest_value = product_option_value.size
                endif
              -%}
              <label
                class="variant-option__button-label{% if variant_style == 'swatch' %} variant-option__button-label--has-swatch{% endif %}"
              >
                <input
                  type="radio"
                  name="{{ product_option.name | escape }}-{{ block.id }}-{{ product_resource.id }}"
                  value="{{ product_option_value | escape }}"
                  aria-label="{{ swatch_aria_label }}"
                  {% if product_option_value.available == false %}
                    aria-disabled="true"
                  {% endif %}
                  data-previous-checked="false"
                  data-fieldset-index="{{ fieldset_index }}"
                  data-input-index="{{ forloop.index0 }}"
                  data-input-id="{{ product_option.position }}-{{ forloop.index0 }}"
                  data-option-value-id="{{ product_option_value.id }}"
                  data-option-available="{{ product_option_value.available }}"
                  data-connected-product-url="{{ product_option_value.product_url }}"
                  {% if product_option_value.variant.id %}
                    data-variant-id="{{ product_option_value.variant.id }}"
                  {% endif %}
                  {% if product_option_value.selected %}
                    data-current-checked="true"
                    checked
                  {% else %}
                    data-current-checked="false"
                  {% endif %}
                >
                {% if variant_style == 'swatch' %}
                  {% if custom_swatch != blank %}
                    <span
                      class="custom-swatch"
                      style="--custom-swatch-height: {{ block_settings.custom_swatch_height }}px;"
                      aria-hidden="true"
                    >
                      {% if custom_swatch.icon != blank %}
                        {{ custom_swatch.icon | image_url: width: block_settings.custom_swatch_size | image_tag: class: 'custom-swatch__icon', loading: 'lazy', alt: '' }}
                      {% endif %}
                      <span class="custom-swatch__name">{{ custom_swatch.name.value | default: custom_swatch.name }}</span>
                      {% if custom_swatch.description != blank %}
                        {%- liquid
                          # Shopify rich_text metaobject fields return their JSON AST when templated.
                          # Force string coercion first (append: ''), then split on the leaf "value"
                          # key to extract plain text without relying on the Drop's contains method.
                          assign _desc_raw = custom_swatch.description | append: ''
                          assign _desc_parts = _desc_raw | split: '"value":"'
                          if _desc_parts.size > 1
                            assign _desc_text = _desc_parts.last | split: '"' | first
                          else
                            assign _desc_text = _desc_raw
                          endif
                        -%}
                        <span class="custom-swatch__description">{{ _desc_text }}</span>
                      {% endif %}
                    </span>
                  {% else %}
                    {%- liquid
                      assign featured_media = product_option_value.variant.featured_media
                      if featured_media == blank and product_option_value.product_url
                        assign featured_media = product_option_value.variant.product.featured_media
                      endif
                    -%}
                    {% render 'swatch',
                      swatch: product_option_value.swatch,
                      variant_image: featured_media,
                      mode: 'unscaled'
                    %}
                  {% endif %}
                {% else %}
                  {% if product_option_value.available == true %}
                    <span
                      class="variant-option__button-label__pill"
                      data-key="variant-option-pill"
                    ></span>
                  {% endif %}
                  <span
                    class="variant-option__button-label__text"
                    data-key="variant-option-text"
                  >
                    {{- product_option_value | escape -}}
                  </span>
                {% endif %}
                {% render 'strikethrough-variant', product_option: product_option_value %}
              </label>
            {%- endfor -%}
            {% if option_id_attribute %}
              {% style %}
                [data-option-id="{{ fieldset_id }}"] {
                  --variant-ch: {{ longest_value | times: 0.65 }}em;
                }
              {% endstyle %}
            {% endif %}
          </fieldset>
        {%- elsif block_settings.variant_style == 'dropdowns' -%}
          {% liquid
            assign property_being_updated = false
            if settings.variant_swatch_width != settings.variant_swatch_height
              assign property_being_updated = true
              assign new_width = settings.variant_swatch_width | times: 1.0 | divided_by: settings.variant_swatch_height | times: 20
            endif
          %}

          <div class="variant-option variant-option--dropdowns">
            <label for="Option-{{ block.id }}-{{ forloop.index0 }}">{{ product_option.name | escape }}</label>
            <div
              class="variant-option__select-wrapper"
              style="
                {%- if property_being_updated -%}
                  --variant-picker-swatch-width: clamp(10px,{{ new_width }}px, 50px);
                {%- endif -%}
              "
            >
              <select
                id="Option-{{ block.id }}-{{ forloop.index0 }}"
                name="options[{{ product_option.name | escape }}]"
                class="variant-option__select"
              >
                {%- for product_option_value in product_option.values -%}
                  <option
                    value="{{ product_option_value | escape }}"
                    data-input-id="{{ product_option.position }}-{{ forloop.index0 }}"
                    data-option-value-id="{{ product_option_value.id }}"
                    data-variant-id="{{ product_option_value.variant.id }}"
                    data-connected-product-url="{{ product_option_value.product_url }}"
                    {% if product_option_value.selected %}
                      selected="selected"
                    {% endif %}
                  >
                    {% if product_option_value.available == false %}
                      {{ product_option_value | escape }} - {{ 'content.unavailable' | t }}
                    {% else %}
                      {{ product_option_value | escape }}
                    {% endif %}
                  </option>
                {%- endfor -%}
              </select>
              <svg
                aria-hidden="true"
                focusable="false"
                class="icon icon-caret"
                viewBox="0 0 10 6"
              >
                {%- render 'icon', icon: 'caret' -%}
              </svg>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}

      <script type="application/json">
        {{ product_resource.selected_or_first_available_variant | json }}
      </script>
    </form>
  </variant-picker>
{% endunless %}

{% stylesheet %}
  /* ── Custom swatch fieldset — 3-column grid ─────────────────────────── */
  .variant-option--custom-swatches {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--gap-sm);
    border: 0;
    padding: 0;
    margin: 0;
  }

  /* Legend spans all three columns */
  .variant-option--custom-swatches legend {
    grid-column: 1 / -1;
    width: 100%;
  }

  /* Label fills its grid cell so the swatch card stretches full width */
  .variant-option--custom-swatches .variant-option__button-label {
    display: flex;
    width: 100%;
    padding: 0;
    border: none;
    background: none;
    line-height: 1;
  }

  /* ── Swatch card ────────────────────────────────────────────────────── */
  .custom-swatch {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    width: 100%;
    min-height: var(--custom-swatch-height, 150px);
    padding: var(--padding-sm, 8px);
    border-radius: var(--style-border-radius-inputs, 4px);
    /* overflow:hidden clips child content to the border-radius but causes the
       CSS border to be partially obscured at corners. Instead, the border is
       rendered via a ::after pseudo-element that overlays on top. */
    overflow: hidden;
    cursor: pointer;
  }

  /* Border overlay — sits on top of content so it's never clipped by overflow:hidden */
  .custom-swatch::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: var(--style-border-width-inputs, 1px) solid var(--color-border);
    pointer-events: none;
    transition: border-color 0.15s ease, border-width 0.15s ease;
    z-index: 1;
  }

  /* Icon — centered, max 50px tall */
  .custom-swatch__icon {
    display: block;
    max-height: 50px;
    width: auto;
    max-width: 100%;
    object-fit: contain;
    flex-shrink: 0;
  }

  /* Name */
  .custom-swatch__name {
    flex-shrink: 0;
    font-size: var(--font-paragraph-small--size, 0.75rem);
    font-weight: var(--font-weight-semibold, 600);
    text-align: center;
    line-height: 1.25;
    color: var(--color-foreground);
    word-break: break-word;
    overflow-wrap: break-word;
    width: 100%;
  }

  /* Description — wraps inside the swatch card */
  .custom-swatch__description {
    font-size: var(--font-paragraph-small--size, 0.75rem);
    line-height: 1.2;
    text-align: center;
    color: var(--color-foreground);
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    width: 100%;
  }

  /* ── States ─────────────────────────────────────────────────────────── */

  /* Hover — update pseudo-element border */
  .variant-option--custom-swatches .variant-option__button-label:hover .custom-swatch::after {
    border-color: var(--color-selected-variant-hover-border, var(--color-foreground));
  }

  /* Selected — update border color via pseudo-element only, no offset */
  .variant-option--custom-swatches .variant-option__button-label:has(input:checked) .custom-swatch::after {
    border-color: var(--custom-swatch-active-border-color, var(--color-foreground));
    border-width: 2px;
  }

  /* Unavailable */
  .variant-option--custom-swatches .variant-option__button-label:has(input[aria-disabled="true"]) .custom-swatch {
    opacity: 0.45;
  }
{% endstylesheet %}
